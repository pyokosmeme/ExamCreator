<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>{{course_title}} - {{exam_title}}</title>

<style>
/* ===== Screen styles ===== */
html, body { margin: 0; padding: 0; font-family: "Times New Roman", Georgia, serif; font-size: 11pt; line-height: 1.4; color: #000; background: #fff; }
h1, h2, h3, h4 { margin: 0.6rem 0 0.35rem 0; font-weight: 700; color: #000; }
p { margin: 0.35rem 0; }
img { max-width: 100%; height: auto; display: block; }
.section-title { font-weight: 700; font-size: 14pt; margin: 0.6rem 0 0.4rem 0; }

.doc-section { padding: 18px 24px; }
.question { padding: 0; margin: 0.9rem 0 1.1rem 0; border: 0; background: transparent; }
.question .stem { margin-bottom: 0.45rem; }
.option { margin: 0.18rem 0; }

/* First page (screen preview) */
.instructions { background: #fff; color: #000; padding: 0.75in 0.9in 0.6in 0.9in; position: relative; }
.nd-block { position: absolute; top: 0.9in; left: 0.9in; }
.nd-block p { margin: 0.15rem 0; font-size: 11pt; }
.title-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 2.0in; margin-bottom: 1.8in; text-align: center; }
.title-wrap h1 { font-size: 28pt; font-weight: 600; margin: 0 0 0.25rem 0; }
.title-wrap h2 { font-size: 22pt; font-weight: 600; margin: 0; }

.inst-heading { color: #2b579a; font-weight: 700; margin: 0 0 0.25rem 0; display: inline-block; }

/* Later pages (screen preview padding) */
.doc-section.second, .doc-section.third, .doc-section.fourth { padding: 0.8in 0.9in 0.6in 0.9in; }

/* Equation sheet container */
.grid-container { display: flex; gap: 24px; align-items: flex-start; margin: 0.2in 0 0.15in 0; padding: 0; }
.grid-container > div { flex: 1 1 0; min-width: 0; }

/* Equation sections and groups */
.equation-section { margin: 0.4rem 0 0.6rem 0; padding: 0; background: none; border: 0; }
.equation-title { margin: 0.1rem 0 0.3rem 0; font-weight: 700; font-size: 12pt; }
.equation-group { margin: 0 0 0.5rem 0; break-inside: avoid; }
.equation-subtitle { font-weight: 700; margin: 0 0 0.2rem 0; }
.equation { margin: 0.14rem 0; }
.var-defs { margin-top: 0.25rem; font-size: 10.5pt; line-height: 1.35; }

/* re-adding variant mark */
/* Tiny superscript for the variant mark next to "Instructions" */
.inst-heading .variant-mark,
.inst-heading sup.variant-mark {
  font-size: 0.4em;
  line-height: 0;
  vertical-align: -0.05em;
  opacity: 0.38;
  position: relative;
  left: -0.02em;
  margin-left: 0.1em;
}

@media print {
  .inst-heading .variant-mark,
  .inst-heading sup.variant-mark {
    font-size: 0.4em !important;
    line-height: 0 !important;
    vertical-align: -0.05em !important;
    opacity: 0.38 !important;
  }
}


/* Labels */
.q-label { color: #2b579a; font-weight: 700; }
.q-label + * { margin-left: 0.05rem; }

/* ===== Print overrides: true 1-inch and adjusted layout ===== */
.firstpage-only { break-after: page; }

@media print {
  @page { size: Letter; margin: 1in; }
  html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* Remove all paddings so only @page margins apply */
  .instructions,
  .doc-section,
  .doc-section.second,
  .doc-section.third,
  .doc-section.fourth { padding: 0 !important; }

  /* Move front-page content further down */
  .title-wrap { margin-top: 1.25in; margin-bottom: 0.9in; } /* pushes instructions lower */
  .inst-heading { margin-top: 0.35in; } /* extra space before instruction text */

  /* Name/Date block placed within content flow on print */
  .nd-block { position: static; margin-bottom: 0.5rem; }

  /* Slightly shrink the first constants image to prevent spillover */
  .doc-section.fourth img:first-of-type { width: 550px !important; max-width: 100%; }

  .grid-container { margin: 0.15in 0 0.1in 0; }

  .question, .equation, .equation-section, .equation-group, .var-defs { page-break-inside: avoid; break-inside: avoid; }
  h1, h2, h3, h4 { page-break-after: avoid; orphans: 3; widows: 3; }
}
</style>
</head>

<body>
<div id="app">Loadingâ€¦</div>

<script id="tpl" type="text/x-handlebars-template">
<div class="instructions firstpage-only">
  <div class="nd-block"><p>Name:</p><p>Date:</p></div>
  <div class="title-wrap">
    <h1>{{course_title}}</h1>
    <h2>{{exam_title}}</h2>
  </div>

  <h3 class="inst-heading">{{{instructions_heading}}}{{#if variant_mark}}<sup class="variant-mark">{{variant_mark}}</sup>{{/if}}</h3>
  {{#each instructions_paragraphs}}<p>{{{this}}}</p>{{/each}}
</div>

<div class="doc-section second">
  <h2 class="section-title">{{mc_section_title}}</h2>
  <p>{{{mc_section_intro}}}</p>
  {{#each mc_questions}}
    <div class="question">
      <div class="stem"><span class="q-label">[{{label}}] </span>{{#if stem_html}}{{{stem_html}}}{{else}}{{{stem}}}{{/if}}</div>
      {{#each options}}<div class="option">{{{this}}}</div>{{/each}}
      {{#if trailing_image}}
        <img alt="{{trailing_image.alt}}" src="{{trailing_image.src}}" style="display:block; width: {{trailing_image.width}}; height:auto;"/>
      {{else}}
        {{#if image_src}}<img alt="{{image_alt}}" src="{{image_src}}" style="display:block; width: {{image_width}}; height:auto;"/>{{/if}}
      {{/if}}
    </div>
  {{/each}}
</div>

<div class="doc-section third">
  <h2 class="section-title">{{calc_section_title}}</h2>
  <p>{{{calc_section_intro}}}</p>
  {{#each calc_questions}}
    <div class="question">
      <div class="stem"><span class="q-label">[{{label}}] </span>{{#if stem_html}}{{{stem_html}}}{{else}}{{{stem}}}{{/if}}</div>
      {{#each options}}<div class="option">{{{this}}}</div>{{/each}}
      {{#if trailing_image}}
        <img alt="{{trailing_image.alt}}" src="{{trailing_image.src}}" style="display:block; width: {{trailing_image.width}}; height:auto;"/>
      {{else}}
        {{#if image_src}}<img alt="{{image_alt}}" src="{{image_src}}" style="display:block; width: {{image_width}}; height:auto;"/>{{/if}}
      {{/if}}
    </div>
  {{/each}}
</div>

<div class="doc-section fourth">
  {{#if constants_image.src}}
    <img alt="{{constants_image.alt}}" src="{{constants_image.src}}" style="display:block; width:650px; height:auto; max-width:100%;"/>
  {{/if}}

  <h2 class="section-title" style="margin-top:20px;">{{trigcalc_title}}</h2>
  {{#if trigcalc_image.src}}
    <img alt="{{trigcalc_image.alt}}" src="{{trigcalc_image.src}}" style="display:block; width:650px; height:auto; max-width:100%;"/>
  {{/if}}

  {{#if equations_title}}
    <h2 class="section-title" style="margin-top:20px;">{{equations_title}}</h2>
  {{/if}}

  <div class="grid-container">
    <div>
      {{#each left_equation_sections}}
        <div class="equation-section">
          {{#if title}}<div class="equation-title">{{title}}</div>{{/if}}
          {{#each groups}}
            <div class="equation-group">
              {{#if subtitle}}<div class="equation-subtitle">{{{subtitle}}}</div>{{/if}}
              {{#each lines}}<div class="equation">{{{this}}}</div>{{/each}}
            </div>
          {{/each}}
          {{#if var_defs}}
            <div class="var-defs">
              <div class="equation-title">Variable definitions</div>
              <ul class="var-list">
                {{#each var_defs}}<li><strong>{{label}}: </strong>{{text}}</li>{{/each}}
              </ul>
            </div>
          {{/if}}
        </div>
      {{/each}}
    </div>

    <div>
      {{#each right_equation_sections}}
        <div class="equation-section">
          {{#if title}}<div class="equation-title">{{title}}</div>{{/if}}
          {{#each groups}}
            <div class="equation-group">
              {{#if subtitle}}<div class="equation-subtitle">{{{subtitle}}}</div>{{/if}}
              {{#each lines}}<div class="equation">{{{this}}}</div>{{/each}}
            </div>
          {{/each}}
          {{#if var_defs}}
            <div class="var-defs">
              <div class="equation-title">Variable definitions</div>
              <ul class="var-list">
                {{#each var_defs}}<li><strong>{{label}}: </strong>{{text}}</li>{{/each}}
              </ul>
            </div>
          {{/if}}
        </div>
      {{/each}}

      {{#if extra_right_placeholder}}<div class="equation-section"></div>{{/if}}
    </div>
  </div>
</div>
</script>

<script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"></script>
<script>
async function render() {
  const mount = document.getElementById('app');
  try {
    const template = Handlebars.compile(document.getElementById('tpl').innerHTML);
    const resp = await fetch('exam_data.json', { cache: 'no-cache' });
    if (!resp.ok) throw new Error(`Failed to load exam_data.json (${resp.status})`);
    const data = await resp.json();

    // Set page title here (since <head><title> isn't templated)
    document.title = `${data.course_title || 'Course'} - ${data.exam_title || 'Exam'}`;

    if (!data.trigcalc_title) data.trigcalc_title = "Trigonometry & Calculus";
    if (!data.trigcalc_image || !data.trigcalc_image.src) {
      data.trigcalc_image = { src: "trig_calc.PNG", alt: "Table of Trig and Calc" };
    }
    if (!data.equations_title) data.equations_title = "Key Equations";

    const norm = (arr = []) => arr.map(q => {
      const trailing_image = q.trailing_image ??
        (q.image_src ? { src: q.image_src, alt: q.image_alt || "", width: q.image_width || "200px" } : undefined);
      return { ...q, stem_html: q.stem_html ?? q.stem ?? "", trailing_image };
    });
    data.mc_questions   = norm(data.mc_questions);
    data.calc_questions = norm(data.calc_questions);

    data.left_equation_sections  = Array.isArray(data.left_equation_sections)  ? data.left_equation_sections  : [];
    data.right_equation_sections = Array.isArray(data.right_equation_sections) ? data.right_equation_sections : [];

    mount.innerHTML = template(data);
  } catch (e) {
    console.error(e);
    mount.innerHTML = `
      <div style="padding:16px; color:#b00020;">
        <strong>Could not render the exam.</strong><br/>
        ${e.message}<br/>
        <small>Serve this folder (e.g., <code>python -m http.server 8000</code>) so <code>fetch()</code> can read <code>exam_data.json</code>.</small>
      </div>`;
  }
}
window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
